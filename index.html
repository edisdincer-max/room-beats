<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Roombeat · Erasmus Rooms Kadıköy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #0b47ff;
      --accent: #ffd447;
      --accent-dark: #f0b800;
      --text: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 32px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .logo-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent);
      border: 2px solid #000;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.6);
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      opacity: 0.9;
    }

    .btn {
      border-radius: 999px;
      border: 2px solid #020617;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      background: #0f172a;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
    }

    .btn-primary:hover {
      background: var(--accent-dark);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text);
    }

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 18px;
      align-items: stretch;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    @media (max-width: 840px) {
      .hero {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    h1 {
      font-size: clamp(26px, 4vw, 32px);
      margin: 0 0 8px;
    }

    .hero-lead {
      font-size: 14px;
      max-width: 420px;
      opacity: 0.9;
      margin-bottom: 14px;
    }

    .hero-card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 14px 16px;
      border: 2px solid #000;
      box-shadow: 0 16px 40px rgba(15,23,42,0.55);
    }

    .hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .hero-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 12px;
    }

    .stat {
      min-width: 90px;
    }

    .stat strong {
      display: block;
      font-size: 16px;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      font-size: 11px;
    }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      opacity: 0.9;
    }

    .map-card {
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 10px;
      border: 2px solid #000;
      box-shadow: 0 16px 40px rgba(15,23,42,0.55);
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }

    #map {
      border-radius: 12px;
      border: 1px solid #000;
      flex: 1;
      min-height: 230px;
    }

    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .toggle-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
      cursor: pointer;
      opacity: 0.8;
    }

    .chip.active {
      background: var(--accent);
      color: #000;
      opacity: 1;
    }

    .list-card {
      margin-top: 10px;
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 10px 12px;
      border: 2px solid #000;
      box-shadow: 0 16px 40px rgba(15,23,42,0.55);
      font-size: 12px;
    }

    .list-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .room-list {
      max-height: 170px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .room-item {
      padding: 6px 0;
      border-bottom: 1px dashed rgba(51,65,85,0.9);
      cursor: pointer;
    }

    .room-item:last-child {
      border-bottom: none;
    }

    .room-item strong {
      display: block;
      font-size: 13px;
    }

    .muted {
      opacity: 0.72;
    }

    footer {
      margin-top: 16px;
      font-size: 11px;
      opacity: 0.72;
    }

    /* Map overlay (sign-in lock) */
    .map-wrapper {
      position: relative;
      flex: 1;
      min-height: 230px;
    }

    .blurred-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.1), rgba(15,23,42,0.9));
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      border-radius: 12px;
      z-index: 10;
    }

    .blurred-overlay span {
      font-size: 11px;
      background: rgba(15,23,42,0.96);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      background: #020617;
      color: #e5e7eb;
      border-radius: 18px;
      padding: 18px 18px 16px;
      border: 2px solid #000;
      box-shadow: 0 20px 60px rgba(15,23,42,0.8);
      width: 100%;
      max-width: 360px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal h2 {
      font-size: 16px;
      margin: 0;
    }

    .modal p {
      font-size: 12px;
      margin: 0 0 10px;
      opacity: 0.85;
    }

    .field-label {
      font-size: 11px;
      margin-bottom: 3px;
      opacity: 0.9;
    }

    input[type="email"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      margin-bottom: 10px;
    }

    input[type="email"]::placeholder {
      color: #6b7280;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .status-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="logo">
        <div class="logo-badge">RB</div>
        <div>
          <div>ROOMBEAT</div>
          <div style="font-size:10px; opacity:0.8;">Kadıköy · Erasmus Rooms</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <span id="sessionStatus" class="pill">Signed out</span>
        <button id="openAuth" class="btn btn-primary">Sign in</button>
      </div>
    </header>

    <div class="hero">
      <section class="hero-card">
        <div class="hero-meta">
          <span class="pill">Furnished rooms & verified tenants</span>
          <span class="pill">Moda · Rıhtım · Halitağa · Yeldeğirmeni</span>
        </div>
        <h1>Your home in the heart of Kadıköy</h1>
        <p class="hero-lead">
          28 rooms across 6 apartments in walking distance to Marmara Göztepe, Medeniyet, the ferry and the best coffee spots in Moda.
        </p>
        <div class="hero-stats">
          <div class="stat">
            <strong>28</strong>
            <span>Rooms</span>
          </div>
          <div class="stat">
            <strong>6</strong>
            <span>Apartments</span>
          </div>
          <div class="stat">
            <strong>4</strong>
            <span>Neighbourhoods</span>
          </div>
          <div class="stat">
            <strong>€480–700</strong>
            <span>Typical monthly</span>
          </div>
        </div>
        <div class="tag-row">
          <span class="tag">Erasmus ready</span>
          <span class="tag">Bills included</span>
          <span class="tag">Walking distance to uni</span>
          <span class="tag">Airport bus & metro nearby</span>
        </div>
      </section>

      <section class="map-card">
        <div class="map-header">
          <div>
            <div style="font-size:12px;">Kadıköy map</div>
            <div style="font-size:10px; opacity:0.8;">Universities & Roombeat apartments</div>
          </div>
          <div class="toggle-row">
            <button class="chip active" data-layer="rooms">Rooms</button>
            <button class="chip active" data-layer="unis">Universities</button>
          </div>
        </div>
        <div class="map-wrapper">
          <div id="map"></div>
          <div id="mapOverlay" class="blurred-overlay">
            <span>Sign in to see precise locations</span>
          </div>
        </div>
      </section>
    </div>

    <section class="list-card">
      <div class="list-title">
        <div>
          <div style="font-size:13px;">Available rooms</div>
          <div class="muted" style="font-size:11px;">Moda (3), Rıhtım (1), Halitağa (1), Yeldeğirmeni (1)</div>
        </div>
        <span style="font-size:11px;" class="muted">Click to focus on map</span>
      </div>
      <div id="roomList" class="room-list"></div>
    </section>

    <footer>
      Universities & fun spots are public. Your houses are approximate and visible after sign-in.
    </footer>
  </div>

  <!-- Auth Modal -->
  <div id="authBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>Email sign in</h2>
        <button id="closeAuth" class="btn btn-ghost" style="padding:4px 8px; font-size:11px;">Close</button>
      </div>
      <p>We send you a magic link. No passwords, just click the link in your inbox and you’ll be signed in on this device.</p>
      <div>
        <div class="field-label">Email</div>
        <input id="emailInput" type="email" placeholder="erasmus.student@example.com" autocomplete="email">
      </div>
      <div class="modal-footer">
        <button id="sendMagicLink" class="btn btn-primary" style="flex: 0 0 auto;">Send magic link</button>
        <span id="authStatus" class="status-badge">Waiting for email</span>
      </div>
    </div>
  </div>

  <script>
    // Supabase client
    const supa = window.supabase.createClient(
      "https://toslxiowcosjayynwqdc.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvc2x4aW93Y29zanlheW53cWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NTIyMzIsImV4cCI6MjA3ODIyODIzMn0.6mSSo03x2O4nKBQ5KoOEQ2VMPrp69sFY2pygpjBvCIo"
    );

    const authBackdrop = document.getElementById("authBackdrop");
    const openAuthBtn = document.getElementById("openAuth");
    const closeAuthBtn = document.getElementById("closeAuth");
    const sendMagicLinkBtn = document.getElementById("sendMagicLink");
    const emailInput = document.getElementById("emailInput");
    const authStatus = document.getElementById("authStatus");
    const sessionStatus = document.getElementById("sessionStatus");
    const roomListEl = document.getElementById("roomList");
    const mapOverlay = document.getElementById("mapOverlay");

    let map;
    let roomMarkers = [];
    let uniMarkers = [];
    let roomsLayerVisible = true;
    let unisLayerVisible = true;

    // Üniversiteler
    const universities = [
      {
        id: "MARMARA_GOZTEPE",
        name: "Marmara University · Göztepe Campus",
        coords: [40.9860, 29.0575],
        desc: "Main Erasmus campus on the Asian side."
      },
      {
        id: "MEDENIYET",
        name: "Istanbul Medeniyet University",
        coords: [40.9794, 29.0690],
        desc: "Modern campus just above Fikirtepe."
      },
      {
        id: "BAU_BESIKTAS",
        name: "Bahçeşehir University (BAU) · Beşiktaş",
        coords: [41.0407, 29.0093],
        desc: "Popular Erasmus university by the Bosphorus."
      },
      {
        id: "KADIR_HAS",
        name: "Kadir Has University",
        coords: [41.0241, 28.9494],
        desc: "Golden Horn campus in Cibali."
      },
      {
        id: "SABANCI_KARAKOY",
        name: "Sabancı University · Karaköy",
        coords: [41.0243, 28.9733],
        desc: "Downtown Karaköy campus & shuttle hub."
      }
    ];

    // 6 ev – 28 oda
    const apartments = [
      {
        id: "MODA_1",
        name: "Moda Terrace House",
        area: "Moda",
        coords: [40.9869, 29.0246],
        rooms: 6,
        price: "€600–700",
        note: "Large rooms, sea side, 3–5 min to Moda Sahil."
      },
      {
        id: "MODA_2",
        name: "Moda Park Apartment",
        area: "Moda",
        coords: [40.9878, 29.0277],
        rooms: 6,
        price: "€580–650",
        note: "Next to Yoğurtçu Park, quiet street."
      },
      {
        id: "MODA_3",
        name: "Moda Backstreets Loft",
        area: "Moda",
        coords: [40.9858, 29.0231],
        rooms: 5,
        price: "€550–620",
        note: "Loft style, close to coffee shops and bar street."
      },
      {
        id: "RIHTIM_1",
        name: "Rıhtım Ferry Apartment",
        area: "Rıhtım",
        coords: [40.9904, 29.0190],
        rooms: 4,
        price: "€520–600",
        note: "2 minutes to ferry, metro & airport bus."
      },
      {
        id: "HALITAGA_1",
        name: "Halitağa Square House",
        area: "Halitağa",
        coords: [40.9917, 29.0249],
        rooms: 3,
        price: "€500–580",
        note: "Central Kadıköy, walk anywhere in 5 minutes."
      },
      {
        id: "YELDEGIRMENI_1",
        name: "Yeldeğirmeni Erasmus Flat",
        area: "Yeldeğirmeni",
        coords: [40.9902, 29.0261],
        rooms: 4,
        price: "€480–560",
        note: "Street-art district, cafés & bars, 7 min to metro."
      }
    ];

    // MAP
    function initMap() {
      map = L.map("map").setView([40.989, 29.025], 14);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap"
      }).addTo(map);

      addUniversities();
      addApartments();
      populateRoomList();
    }

    function addUniversities() {
      universities.forEach((u) => {
        const marker = L.marker(u.coords, { title: u.name })
          .bindPopup("<b>" + u.name + "</b><br>" + u.desc);
        marker.addTo(map);
        uniMarkers.push(marker);
      });
    }

    function addApartments() {
      const houseIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
        iconSize: [26, 26],
        iconAnchor: [13, 26],
        popupAnchor: [0, -22]
      });

      apartments.forEach((a) => {
        const marker = L.marker(a.coords, {
          icon: houseIcon,
          title: a.name
        }).bindPopup(
          "<b>" + a.name + "</b><br>" +
          a.area + " · " + a.rooms + " rooms<br>" +
          "Typical: <b>" + a.price + "</b><br>" +
          "<span style='font-size:11px; opacity:0.85;'>" + a.note + "</span>"
        );
        marker.addTo(map);
        roomMarkers.push(marker);
      });
    }

    function populateRoomList() {
      roomListEl.innerHTML = "";
      apartments.forEach((a, idx) => {
        const div = document.createElement("div");
        div.className = "room-item";
        div.innerHTML =
          "<strong>" + a.area + " · " + a.name + "</strong>" +
          "<span class='muted'>Rooms: " + a.rooms + " · Typical " + a.price + "</span><br>" +
          "<span class='muted'>" + a.note + "</span>";
        div.onclick = () => {
          map.setView(a.coords, 16);
          roomMarkers[idx].openPopup();
        };
        roomListEl.appendChild(div);
      });
    }

    function setRoomsVisible(visible) {
      roomsLayerVisible = visible;
      roomMarkers.forEach((m) => {
        if (visible) m.addTo(map);
        else map.removeLayer(m);
      });
      updateChips();
    }

    function setUnisVisible(visible) {
      unisLayerVisible = visible;
      uniMarkers.forEach((m) => {
        if (visible) m.addTo(map);
        else map.removeLayer(m);
      });
      updateChips();
    }

    function updateChips() {
      document.querySelectorAll(".chip").forEach((chip) => {
        const layer = chip.dataset.layer;
        if (layer === "rooms") {
          roomsLayerVisible ? chip.classList.add("active") : chip.classList.remove("active");
        }
        if (layer === "unis") {
          unisLayerVisible ? chip.classList.add("active") : chip.classList.remove("active");
        }
      });
    }

    // AUTH UI
    function openAuthModal() {
      authBackdrop.style.display = "flex";
      emailInput.focus();
    }

    function closeAuthModal() {
      authBackdrop.style.display = "none";
    }

    openAuthBtn.addEventListener("click", openAuthModal);
    closeAuthBtn.addEventListener("click", closeAuthModal);

    sendMagicLinkBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      if (!email) {
        authStatus.textContent = "Please enter an email";
        return;
      }

      sendMagicLinkBtn.disabled = true;
      authStatus.textContent = "Sending...";
      try {
        const { error } = await supa.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: window.location.origin
          }
        });
        if (error) {
          console.error(error);
          authStatus.textContent = "Error: " + error.message;
        } else {
          authStatus.textContent = "Magic link sent. Check your inbox.";
        }
      } catch (err) {
        console.error(err);
        authStatus.textContent = "Unexpected error.";
      } finally {
        sendMagicLinkBtn.disabled = false;
      }
    });

    async function refreshSession() {
      const { data, error } = await supa.auth.getSession();
      if (error) {
        console.error(error);
        sessionStatus.textContent = "Error";
        return;
      }

      const session = data.session;
      if (session) {
        sessionStatus.textContent = "Signed in";
        sessionStatus.style.background = "#22c55e1a";
        sessionStatus.style.borderColor = "#22c55e";
        mapOverlay.style.display = "none";
      } else {
        sessionStatus.textContent = "Signed out";
        sessionStatus.style.background = "rgba(15,23,42,0.9)";
        sessionStatus.style.borderColor = "rgba(148,163,184,0.7)";
        mapOverlay.style.display = "flex";
      }
    }

    // Layer chips
    document.addEventListener("click", (ev) => {
      if (ev.target.classList.contains("chip")) {
        const layer = ev.target.dataset.layer;
        if (layer === "rooms") setRoomsVisible(!roomsLayerVisible);
        if (layer === "unis") setUnisVisible(!unisLayerVisible);
      }
    });

    // Init
    window.addEventListener("DOMContentLoaded", async () => {
      initMap();
      await refreshSession();
      supa.auth.onAuthStateChange(() => {
        refreshSession();
      });
    });
  </script>
</body>
</html>

